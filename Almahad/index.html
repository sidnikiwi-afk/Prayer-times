<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Mahad Ul Islami - Ramadhan 1447 Timetable</title>
    <meta name="description" content="Ramadan 1447 prayer timetable for Al Mahad Ul Islami, Bradford">
    <meta property="og:title" content="Al Mahad Ul Islami - Ramadan 1447 Prayer Timetable">
    <meta property="og:description" content="Al Mahad Ul Islami, Bradford - Sehri, Iftar & prayer times with live countdown">
    <meta property="og:url" content="https://waqt.uk/Almahad/">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://waqt.uk/Almahad/og-image.svg">
    <meta name="theme-color" content="#1b5e20">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Al Mahad Times">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ•Œ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231b5e20' width='100' height='100' rx='20'/><text x='50' y='50' text-anchor='middle' dominant-baseline='central' font-size='60'>ðŸŒ™</text></svg>">
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #1a1a1a;
            padding: 10px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            text-align: center;
            padding: 20px 15px;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #388e3c 100%);
            color: white;
        }
        .mosque-icon { font-size: 50px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        h1 { font-size: clamp(18px, 5vw, 28px); font-weight: bold; letter-spacing: 2px; margin-bottom: 5px; }
        .address { font-size: clamp(11px, 3vw, 14px); opacity: 0.9; margin-bottom: 4px; }
        .month-year {
            font-size: clamp(14px, 4vw, 18px);
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 6px;
        }
        .moon-sighting {
            font-size: clamp(10px, 2.5vw, 12px);
            margin-top: 8px;
            opacity: 0.85;
            font-style: italic;
        }

        /* Countdown */
        .countdown-section {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            padding: 15px;
            text-align: center;
        }
        .countdown-section.pre-ramadan {
            background: linear-gradient(135deg, #1b5e20 0%, #388e3c 100%);
        }
        .countdown-section.iftar-mode {
            background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%);
        }
        .countdown-label { font-size: 14px; margin-bottom: 8px; opacity: 0.9; }
        .countdown-display { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .countdown-item {
            background: rgba(255,255,255,0.15);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 70px;
        }
        .countdown-value { font-size: clamp(24px, 6vw, 36px); font-weight: bold; }
        .countdown-unit { font-size: 11px; text-transform: uppercase; opacity: 0.8; }
        .next-prayer {
            margin-top: 10px;
            font-size: clamp(13px, 3.5vw, 16px);
            font-weight: 600;
            line-height: 1.6;
        }
        .next-prayer-time {
            background: rgba(255,255,255,0.2);
            padding: 3px 12px;
            border-radius: 15px;
            white-space: nowrap;
            display: inline-block;
        }

        /* Dua */
        .dua-section { display: flex; flex-wrap: wrap; font-size: 12px; }
        .dua-box { flex: 1 1 250px; text-align: center; padding: 15px 10px; color: white; }
        .dua-box.intention { background: #1b5e20; }
        .dua-box.completing { background: #b71c1c; }
        .dua-title { font-style: italic; font-size: 11px; margin-bottom: 5px; opacity: 0.9; }
        .dua-arabic { font-size: 13px; margin-bottom: 3px; font-weight: 500; }
        .dua-translation { font-style: italic; font-size: 10px; opacity: 0.85; }

        /* Table */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: clamp(10px, 2.5vw, 12px);
            min-width: 700px;
        }
        thead tr:first-child th { padding: 10px 4px; font-weight: 600; color: white; }
        .header-ramadan { background: #1a1a1a; }
        .header-beginning { background: #1b5e20; }
        .header-jamaah { background: #b71c1c; }
        thead tr:nth-child(2) th {
            background: #f0f0f0; color: #1a1a1a;
            padding: 8px 4px; font-size: clamp(9px, 2vw, 11px);
            border: 1px solid #ccc; position: sticky; top: 0; z-index: 10;
        }
        tbody tr { transition: all 0.3s ease; }
        tbody tr:nth-child(odd) { background: #fafafa; }
        tbody tr:nth-child(even) { background: white; }
        tbody tr:hover { background: #e8f5e9 !important; }
        td { padding: 8px 4px; text-align: center; border: 1px solid #ddd; }
        .date-col { font-weight: 600; }
        .friday { background: #ffebee !important; }
        .friday:hover { background: #ffcdd2 !important; }
        .friday .day-col { color: #b71c1c; font-weight: bold; }
        .sehri-col { color: #b71c1c; font-weight: bold; }
        .iftari-col { font-weight: bold; color: #1b5e20; }

        /* Last 10 */
        .last-ten { border-left: 3px solid #ffc107; }
        .last-ten .no-col { color: #b8860b; font-weight: bold; }
        .last-ten-badge {
            display: inline-block; background: #ffc107; color: #1a1a1a;
            font-size: 7px; padding: 1px 4px; border-radius: 8px;
            margin-left: 3px; font-weight: bold; vertical-align: middle;
        }
        .odd-night { border-left: 3px solid #ff8c00; }
        .odd-night .no-col { color: #ff8c00; font-weight: bold; }

        /* Today */
        .today {
            background: linear-gradient(90deg, #fff3cd 0%, #ffeeba 100%) !important;
            box-shadow: inset 0 0 0 2px #ffc107;
            animation: pulse 2s infinite;
        }
        .today td { border-color: #ffc107; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
        .today-badge {
            display: inline-block; background: #ffc107; color: #1a1a1a;
            font-size: 8px; padding: 2px 6px; border-radius: 10px;
            margin-left: 5px; font-weight: bold; vertical-align: middle;
        }

        /* Sunnah Section */
        .sunnah-section {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            padding: 20px 15px;
        }
        .sunnah-section h2 {
            text-align: center;
            font-size: clamp(16px, 4vw, 22px);
            margin-bottom: 15px;
            color: #ffc107;
        }
        .sunnah-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }
        .sunnah-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            line-height: 1.5;
        }
        .sunnah-item strong {
            color: #ffc107;
            display: block;
            margin-bottom: 3px;
            font-size: 13px;
        }

        /* Footer */
        .footer { display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: #f5f5f5; }
        .footer-section { flex: 1 1 200px; text-align: center; padding: 10px; }
        .eid-info { background: #1b5e20; color: white; border-radius: 8px; }
        .footer-section strong { color: #b71c1c; }
        .eid-info strong { color: #ffc107; }
        .fitrana-box { background: white; border-radius: 8px; border: 2px solid #1b5e20; }
        .contact-box { background: white; border-radius: 8px; }

        /* Floating buttons */
        .dark-mode-toggle {
            position: fixed; bottom: 20px; right: 20px;
            background: #1b5e20; color: white; border: none;
            padding: 12px 15px; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 18px;
            z-index: 100; transition: all 0.3s ease;
        }
        .dark-mode-toggle:hover { transform: scale(1.1); }
        .share-btn {
            position: fixed; bottom: 80px; right: 20px;
            background: #25D366; color: white; border: none;
            padding: 12px 15px; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 18px;
            z-index: 100; transition: all 0.3s ease;
        }
        .share-btn:hover { transform: scale(1.1); }
        .notify-btn {
            position: fixed; bottom: 140px; right: 20px;
            background: #b71c1c; color: white; border: none;
            padding: 12px 15px; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 18px;
            z-index: 100; transition: all 0.3s ease;
        }
        .notify-btn:hover { transform: scale(1.1); }
        .notify-btn.active { background: #1b5e20; }

        /* Dark mode */
        body.dark-mode { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        body.dark-mode .container { background: #1f1f1f; color: #e0e0e0; }
        body.dark-mode thead tr:nth-child(2) th { background: #2d2d2d; color: #e0e0e0; border-color: #444; }
        body.dark-mode tbody tr:nth-child(odd) { background: #252525; }
        body.dark-mode tbody tr:nth-child(even) { background: #1f1f1f; }
        body.dark-mode tbody tr:hover { background: #2d3a2e !important; }
        body.dark-mode td { border-color: #444; }
        body.dark-mode .friday { background: #3d2525 !important; }
        body.dark-mode .today { background: linear-gradient(90deg, #3d3520 0%, #4a4025 100%) !important; }
        body.dark-mode .footer { background: #252525; }
        body.dark-mode .fitrana-box, body.dark-mode .contact-box { background: #2d2d2d; color: #e0e0e0; }
        body.dark-mode .sehri-col { color: #ff6b6b; }
        body.dark-mode .iftari-col { color: #66bb6a; }
        body.dark-mode .last-ten-badge { background: #b8860b; color: white; }

        /* View Toggle */
        .view-toggle {
            display: flex;
            justify-content: center;
            padding: 12px 15px;
            background: #f5f5f5;
        }
        .view-btn {
            padding: 8px 24px;
            border: 2px solid #1b5e20;
            background: transparent;
            color: #1b5e20;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.25s ease;
            letter-spacing: 0.5px;
        }
        .view-btn:first-child { border-radius: 20px 0 0 20px; border-right: none; }
        .view-btn:last-child { border-radius: 0 20px 20px 0; }
        .view-btn.active { background: #1b5e20; color: white; }
        body.dark-mode .view-toggle { background: #252525; }
        body.dark-mode .view-btn { border-color: #66bb6a; color: #66bb6a; }
        body.dark-mode .view-btn.active { background: #66bb6a; color: #1a1a1a; }

        /* Today View */
        .today-view { padding: 15px; }
        .today-date-bar {
            text-align: center; padding: 10px; font-size: 14px;
            font-weight: 600; color: #1b5e20;
            border-bottom: 1px solid #eee; margin-bottom: 12px;
        }
        .today-cards { display: flex; flex-direction: column; gap: 10px; }
        .prayer-card {
            border-radius: 10px; padding: 14px 16px; background: #fafafa;
            border: 2px solid transparent; transition: all 0.3s ease;
        }
        .prayer-card.passed { opacity: 0.45; }
        .prayer-card.passed .prayer-card-name::after { content: ' \2713'; color: #1b5e20; }
        .prayer-card.active-prayer {
            border-color: #1b5e20;
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            box-shadow: 0 2px 12px rgba(27,94,32,0.15);
        }
        .prayer-card-header { display: flex; justify-content: space-between; align-items: center; }
        .prayer-card-name { font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .prayer-card-time { font-size: 22px; font-weight: 700; color: #1b5e20; }
        .prayer-card-details { display: flex; gap: 20px; margin-top: 6px; font-size: 12px; color: #666; }
        .prayer-card-detail strong { color: #333; }
        .next-badge {
            display: inline-block; background: #1b5e20; color: white;
            font-size: 9px; padding: 2px 8px; border-radius: 10px;
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            margin-left: 8px; vertical-align: middle; animation: pulse 2s infinite;
        }
        .today-tomorrow {
            margin-top: 15px; text-align: center; padding: 12px;
            background: linear-gradient(135deg, #1b5e20, #388e3c);
            color: white; border-radius: 10px; font-size: 13px; font-weight: 600;
        }
        body.dark-mode .today-date-bar { color: #66bb6a; border-bottom-color: #444; }
        body.dark-mode .prayer-card { background: #252525; }
        body.dark-mode .prayer-card.active-prayer { background: linear-gradient(135deg, #1a3c1b, #1f4a20); border-color: #66bb6a; }
        body.dark-mode .prayer-card-time { color: #66bb6a; }
        body.dark-mode .prayer-card-details { color: #999; }
        body.dark-mode .prayer-card-detail strong { color: #ccc; }
        body.dark-mode .next-badge { background: #66bb6a; color: #1a1a1a; }
        body.dark-mode .prayer-card.passed .prayer-card-name::after { color: #66bb6a; }
        @media (min-width: 600px) {
            .today-view { padding: 20px 30px; }
            .prayer-card-name { font-size: 17px; }
            .prayer-card-time { font-size: 26px; }
        }

        @media print {
            body { background: white !important; padding: 0; }
            .container { box-shadow: none; }
            .dark-mode-toggle, .share-btn, .notify-btn, .audio-btn, .qibla-btn, .qibla-overlay, .countdown-section, .view-toggle, .today-view, .ramadan-progress, #eidConfettiCanvas { display: none !important; }
            .today { background: #fff3cd !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #granimCanvas, #fireflyCanvas { display: none !important; }
            .header::after { display: none !important; }
            .quran-icon { animation: none !important; filter: none !important; }
            .prayer-card, .footer-section, .sunnah-item { animation: none !important; }
            * { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
            tbody tr { transition: none !important; border-left: none !important; }
        }
        @media (max-width: 600px) {
            .countdown-item { min-width: 60px; padding: 8px 10px; }
            .footer-section { flex: 1 1 100%; }
        }
        /* === VISUAL ENHANCEMENTS === */

        /* Header with Granim + arabesque pattern */
        .header {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .header > * { position: relative; z-index: 2; }
        .header::after {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 1;
            opacity: 0.05;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Cg fill='none' stroke='%23ffffff' stroke-width='0.8'%3E%3Ccircle cx='30' cy='30' r='20'/%3E%3Ccircle cx='30' cy='30' r='12'/%3E%3Cpath d='M30 10 Q40 20 30 30 Q20 20 30 10' /%3E%3Cpath d='M30 30 Q40 40 30 50 Q20 40 30 30' /%3E%3Cpath d='M10 30 Q20 20 30 30 Q20 40 10 30' /%3E%3Cpath d='M30 30 Q40 20 50 30 Q40 40 30 30' /%3E%3C/g%3E%3C/svg%3E");
            background-size: 60px 60px;
        }
        body.dark-mode .header::after { opacity: 0.03; }

        /* Granim canvas */
        #granimCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* SVG Quran icon */
        .quran-icon {
            width: 58px; height: 58px;
            margin: 0 auto 10px;
            filter: drop-shadow(0 2px 8px rgba(255, 193, 7, 0.35));
            animation: quranGlow 3s ease-in-out infinite alternate;
        }
        @keyframes quranGlow {
            from { filter: drop-shadow(0 2px 8px rgba(255, 193, 7, 0.25)); }
            to   { filter: drop-shadow(0 2px 14px rgba(255, 193, 7, 0.55)); }
        }
        .mosque-icon { display: none; }

        /* Firefly particles in countdown */
        .countdown-section { position: relative; overflow: hidden; }
        #fireflyCanvas {
            position: absolute;
            inset: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            opacity: 0.6;
        }

        /* Enhanced prayer cards - bottom border accent */
        .prayer-card {
            border-bottom: 3px solid #c8e6c9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        .prayer-card:not(.passed):not(.active-prayer) {
            border-bottom-color: #66bb6a;
        }
        .prayer-card.passed {
            border-bottom-color: #ccc;
        }
        .prayer-card.active-prayer {
            border-bottom: 4px solid #1b5e20;
            box-shadow: 0 0 20px rgba(27, 94, 32, 0.2), 0 4px 16px rgba(27, 94, 32, 0.12);
            transform: scale(1.015);
        }
        body.dark-mode .prayer-card {
            border-bottom: 3px solid #37474f;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .prayer-card:not(.passed):not(.active-prayer) {
            border-bottom-color: #4caf50;
        }
        body.dark-mode .prayer-card.passed { border-bottom-color: #555; }
        body.dark-mode .prayer-card.active-prayer {
            border-bottom: 4px solid #66bb6a;
            box-shadow: 0 0 20px rgba(102, 187, 106, 0.2), 0 4px 16px rgba(102, 187, 106, 0.1);
        }

        /* Countdown glow */
        .countdown-value {
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.4), 0 0 40px rgba(255, 255, 255, 0.15);
            transition: transform 0.2s ease;
        }
        .countdown-value.tick {
            transform: scale(1.18);
            text-shadow: 0 0 25px rgba(255, 255, 255, 0.6), 0 0 50px rgba(255, 255, 255, 0.25);
        }
        .countdown-item { border: 1px solid rgba(255, 255, 255, 0.15); }

        /* Entrance animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .prayer-card { animation: slideUp 0.4s ease-out both; }
        .prayer-card:nth-child(1) { animation-delay: 0.05s; }
        .prayer-card:nth-child(2) { animation-delay: 0.1s; }
        .prayer-card:nth-child(3) { animation-delay: 0.15s; }
        .prayer-card:nth-child(4) { animation-delay: 0.2s; }
        .prayer-card:nth-child(5) { animation-delay: 0.25s; }
        .prayer-card:nth-child(6) { animation-delay: 0.3s; }
        .sunnah-item { animation: slideUp 0.4s ease-out both; }
        .sunnah-item:nth-child(1) { animation-delay: 0.05s; }
        .sunnah-item:nth-child(2) { animation-delay: 0.1s; }
        .sunnah-item:nth-child(3) { animation-delay: 0.15s; }
        .sunnah-item:nth-child(4) { animation-delay: 0.2s; }
        .sunnah-item:nth-child(5) { animation-delay: 0.25s; }
        .sunnah-item:nth-child(6) { animation-delay: 0.3s; }
        .sunnah-item:nth-child(7) { animation-delay: 0.35s; }
        .sunnah-item:nth-child(8) { animation-delay: 0.4s; }
        .sunnah-item:nth-child(9) { animation-delay: 0.45s; }
        .sunnah-item:nth-child(10) { animation-delay: 0.5s; }
        .footer-section { animation: slideUp 0.5s ease-out both; }
        .footer-section:nth-child(1) { animation-delay: 0.1s; }
        .footer-section:nth-child(2) { animation-delay: 0.15s; }
        .footer-section:nth-child(3) { animation-delay: 0.2s; }

        /* Polished table hover */
        tbody tr { transition: all 0.25s ease; border-left: 3px solid transparent; }
        tbody tr:hover { transform: translateX(2px); border-left-color: #1b5e20; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        body.dark-mode tbody tr:hover { border-left-color: #66bb6a; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* Glass floating buttons */
        .dark-mode-toggle, .share-btn, .notify-btn {
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        .dark-mode-toggle { background: rgba(27, 94, 32, 0.85); }
        .share-btn { background: rgba(37, 211, 102, 0.85); }
        .notify-btn { background: rgba(183, 28, 28, 0.85); }
        .notify-btn.active { background: rgba(27, 94, 32, 0.85); }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .prayer-card, .footer-section, .sunnah-item { animation: none !important; }
            .quran-icon { animation: none !important; }
            .countdown-value { transition: none !important; }
            tbody tr { transition: none !important; }
            #granimCanvas, #fireflyCanvas { display: none !important; }
            /* Disable new animations under reduced motion */
            .flip-digit { animation: none !important; transition: none !important; }
            .quran-icon svg path { animation: none !important; }
            #eidConfettiCanvas { display: none !important; }
        }

        /* === FEATURE 1: Countdown Flip Animation === */
        .flip-digit {
            display: inline-block;
            perspective: 200px;
            transform-style: preserve-3d;
        }
        .flip-digit.flipping {
            animation: flipDigit 0.35s ease-in-out;
        }
        @keyframes flipDigit {
            0% { transform: rotateX(0) scale(1); }
            40% { transform: rotateX(-90deg) scale(1.08); }
            70% { transform: rotateX(10deg) scale(1.03); }
            100% { transform: rotateX(0) scale(1); }
        }

        /* === FEATURE 2: Animated Mosque SVG Icon === */
        .quran-icon {
            animation: quranGlow 3s ease-in-out infinite alternate, quranFloat 4s ease-in-out infinite;
        }
        @keyframes quranFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .quran-icon svg .mosque-window-glow {
            animation: windowGlow 3s ease-in-out infinite;
        }
        @keyframes windowGlow {
            0%, 100% { opacity: 0.25; }
            50% { opacity: 0.55; }
        }

        /* === FEATURE 3: Eid Confetti Canvas === */
        #eidConfettiCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* === FEATURE 4: Ramadan Progress Bar === */
        .ramadan-progress {
            position: relative;
            height: 6px;
            background: rgba(0,0,0,0.15);
            overflow: hidden;
        }
        .ramadan-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #66bb6a, #ffd54f, #388e3c);
            border-radius: 0 3px 3px 0;
            transition: width 0.8s ease;
        }
        .ramadan-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 9px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            white-space: nowrap;
            line-height: 6px;
            pointer-events: none;
        }
        body.dark-mode .ramadan-progress {
            background: rgba(255,255,255,0.08);
        }

        /* === FEATURE 6: Audio Alert Toggle Button === */
        .audio-btn {
            position: fixed; bottom: 200px; right: 20px;
            background: rgba(27, 94, 32, 0.85); color: white; border: none;
            padding: 12px 15px; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 18px;
            z-index: 100; transition: all 0.3s ease;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        .audio-btn:hover { transform: scale(1.1); }
        .audio-btn.active { background: rgba(255, 193, 7, 0.9); color: #1a1a1a; }

        /* === FEATURE 7: Qibla Compass === */
        .qibla-btn {
            position: fixed; bottom: 20px; left: 20px;
            background: rgba(27, 94, 32, 0.85); color: white; border: none;
            padding: 12px 15px; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 18px;
            z-index: 100; transition: all 0.3s ease;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        .qibla-btn:hover { transform: scale(1.1); }
        .qibla-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .qibla-overlay.visible { opacity: 1; pointer-events: auto; }
        .qibla-compass-box {
            background: white; border-radius: 20px; padding: 30px;
            text-align: center; max-width: 320px; width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }
        body.dark-mode .qibla-compass-box { background: #1f1f1f; color: #e0e0e0; }
        .qibla-compass-box h3 { color: #1b5e20; margin-bottom: 8px; font-size: 18px; }
        body.dark-mode .qibla-compass-box h3 { color: #66bb6a; }
        .qibla-compass-box p { font-size: 12px; color: #666; margin-bottom: 15px; }
        body.dark-mode .qibla-compass-box p { color: #999; }
        .qibla-compass-dial {
            width: 200px; height: 200px;
            margin: 0 auto 15px;
            position: relative;
        }
        .qibla-compass-dial svg { width: 100%; height: 100%; }
        .qibla-bearing { font-size: 14px; color: #1b5e20; font-weight: 600; }
        body.dark-mode .qibla-bearing { color: #66bb6a; }
        .qibla-close {
            position: absolute; top: 10px; right: 15px;
            background: none; border: none; font-size: 22px;
            cursor: pointer; color: #999; line-height: 1;
        }
        .qibla-close:hover { color: #333; }
        body.dark-mode .qibla-close:hover { color: #ccc; }

        /* === FEATURE 8: Custom Themed Scrollbar === */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e8f5e9; }
        ::-webkit-scrollbar-thumb { background: #388e3c; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #1b5e20; }
        body.dark-mode::-webkit-scrollbar-track { background: #0a1a0a; }
        body.dark-mode::-webkit-scrollbar-thumb { background: #388e3c; }
        body { scrollbar-color: #388e3c #e8f5e9; scrollbar-width: thin; }
        body.dark-mode { scrollbar-color: #388e3c #0a1a0a; }

        /* === FEATURE 9: Skeleton Shimmer for Granim === */
        .header.granim-loading::before {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 0;
            background: linear-gradient(90deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.12) 40%,
                rgba(255,255,255,0.2) 50%,
                rgba(255,255,255,0.12) 60%,
                rgba(255,255,255,0) 100%
            );
            background-size: 200% 100%;
            animation: shimmerSlide 1.5s ease-in-out infinite;
        }
        @keyframes shimmerSlide {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        body.dark-mode .header.granim-loading::before {
            background: linear-gradient(90deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.05) 40%,
                rgba(255,255,255,0.08) 50%,
                rgba(255,255,255,0.05) 60%,
                rgba(255,255,255,0) 100%
            );
            background-size: 200% 100%;
            animation: shimmerSlide 1.5s ease-in-out infinite;
        }

        /* === Print: hide all new interactive elements === */
        @media print {
            .ramadan-progress, .qibla-btn, .qibla-overlay,
            .audio-btn, #eidConfettiCanvas { display: none !important; }
            .quran-icon { animation: none !important; }
            .flip-digit { animation: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <canvas id="granimCanvas"></canvas>
            <div class="quran-icon">
                <svg viewBox="0 0 140 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="mosqueGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="#ffd54f"/>
                            <stop offset="100%" stop-color="#c8a415"/>
                        </linearGradient>
                    </defs>
                    <!-- Base platform -->
                    <rect x="15" y="82" width="110" height="5" rx="2" fill="url(#mosqueGrad)" opacity="0.5"/>
                    <!-- Main building body -->
                    <rect x="25" y="52" width="90" height="30" rx="2" fill="url(#mosqueGrad)" opacity="0.6"/>
                    <!-- Central large dome -->
                    <ellipse cx="70" cy="52" rx="24" ry="20" fill="url(#mosqueGrad)" opacity="0.85"/>
                    <!-- Central dome finial -->
                    <line x1="70" y1="32" x2="70" y2="22" stroke="#ffd54f" stroke-width="1.2"/>
                    <circle cx="70" cy="20" r="2.5" fill="#ffd54f"/>
                    <circle cx="71.2" cy="19.2" r="1.5" fill="#1b5e20"/>
                    <!-- Left small dome -->
                    <ellipse cx="38" cy="52" rx="14" ry="11" fill="url(#mosqueGrad)" opacity="0.7"/>
                    <line x1="38" y1="41" x2="38" y2="36" stroke="#ffd54f" stroke-width="0.8"/>
                    <circle cx="38" cy="34.5" r="1.8" fill="#ffd54f"/>
                    <!-- Right small dome -->
                    <ellipse cx="102" cy="52" rx="14" ry="11" fill="url(#mosqueGrad)" opacity="0.7"/>
                    <line x1="102" y1="41" x2="102" y2="36" stroke="#ffd54f" stroke-width="0.8"/>
                    <circle cx="102" cy="34.5" r="1.8" fill="#ffd54f"/>
                    <!-- Left minaret -->
                    <rect x="17" y="35" width="6" height="47" rx="1" fill="url(#mosqueGrad)" opacity="0.75"/>
                    <path d="M16 35 L20 24 L24 35" fill="url(#mosqueGrad)" opacity="0.85"/>
                    <line x1="20" y1="24" x2="20" y2="17" stroke="#ffd54f" stroke-width="0.8"/>
                    <circle cx="20" cy="15.5" r="1.5" fill="#ffd54f"/>
                    <!-- Minaret balcony -->
                    <rect x="15" y="50" width="10" height="1.5" rx="0.5" fill="#ffd54f" opacity="0.6"/>
                    <!-- Right minaret -->
                    <rect x="117" y="35" width="6" height="47" rx="1" fill="url(#mosqueGrad)" opacity="0.75"/>
                    <path d="M116 35 L120 24 L124 35" fill="url(#mosqueGrad)" opacity="0.85"/>
                    <line x1="120" y1="24" x2="120" y2="17" stroke="#ffd54f" stroke-width="0.8"/>
                    <circle cx="120" cy="15.5" r="1.5" fill="#ffd54f"/>
                    <!-- Minaret balcony -->
                    <rect x="115" y="50" width="10" height="1.5" rx="0.5" fill="#ffd54f" opacity="0.6"/>
                    <!-- Grand arched entrance -->
                    <path class="mosque-window-glow" d="M60 82 L60 64 Q70 55 80 64 L80 82 Z" fill="#1b5e20" opacity="0.45"/>
                    <!-- Side arched windows -->
                    <path class="mosque-window-glow" d="M32 76 L32 68 Q36 63 40 68 L40 76 Z" fill="#1b5e20" opacity="0.35"/>
                    <path class="mosque-window-glow" d="M100 76 L100 68 Q104 63 108 68 L108 76 Z" fill="#1b5e20" opacity="0.35"/>
                    <!-- Decorative star above entrance -->
                    <polygon points="70,57 71.2,60 74,60.4 72,62.2 72.5,65 70,63.5 67.5,65 68,62.2 66,60.4 68.8,60" fill="#ffd54f" opacity="0.7"/>
                </svg>
            </div>
            <h1>AL MAHAD UL ISLAMI</h1>
            <div class="address">Dorset Street, Bradford, BD5 0LT</div>
            <div class="month-year">RAMADHAN 1447 | FEBRUARY - MARCH 2026</div>
            <div class="moon-sighting">Dates are subject to moon sighting confirmation</div>
        </div>

        <div class="ramadan-progress" id="ramadanProgress" style="display:none;">
            <div class="ramadan-progress-fill" id="ramadanProgressFill" style="width:0%"></div>
            <div class="ramadan-progress-text" id="ramadanProgressText"></div>
        </div>

        <div class="countdown-section" id="countdownSection">
            <canvas id="fireflyCanvas"></canvas>
            <div class="countdown-label" id="countdownLabel">Time until Iftar</div>
            <div class="countdown-display">
                <div class="countdown-item" id="daysContainer" style="display: none;">
                    <div class="countdown-value" id="days">--</div>
                    <div class="countdown-unit">Days</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="hours">--</div>
                    <div class="countdown-unit">Hours</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="minutes">--</div>
                    <div class="countdown-unit">Minutes</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="seconds">--</div>
                    <div class="countdown-unit">Seconds</div>
                </div>
            </div>
            <div class="next-prayer" id="nextPrayer"></div>
        </div>

        <div class="dua-section">
            <div class="dua-box intention">
                <div class="dua-title">Intention for fasting</div>
                <div class="dua-arabic">Wa bisawmi ghadin nawaytu min shahri Ramadhan</div>
                <div class="dua-translation">"I intend to keep the fast tomorrow in the month of Ramadhan."</div>
            </div>
            <div class="dua-box completing">
                <div class="dua-title">Completing the Fast Du'a</div>
                <div class="dua-arabic">Allahumma laka sumtu wa 'ala rizqika aftartu</div>
                <div class="dua-translation">"O Allah! For You I have fasted and by what (food) You have blessed me with, have I broken it."</div>
            </div>
        </div>

        <div class="view-toggle" id="viewToggle">
            <button class="view-btn active" data-view="today">Today</button>
            <button class="view-btn" data-view="full">Full Timetable</button>
        </div>

        <div class="today-view" id="todayView" style="display: none;">
            <div class="today-date-bar" id="todayDateBar"></div>
            <div class="today-cards" id="todayCards"></div>
            <div class="today-tomorrow" id="todayTomorrow"></div>
        </div>

        <div class="table-container" id="tableContainer">
            <table id="timetable">
                <thead>
                    <tr>
                        <th colspan="4" class="header-ramadan">RAMADHAN</th>
                        <th colspan="5" class="header-beginning">BEGINNING TIMES</th>
                        <th colspan="5" class="header-jamaah">JAMAAT TIMES</th>
                    </tr>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>No</th>
                        <th>Sehri</th>
                        <th>Fajr</th>
                        <th>Sunrise</th>
                        <th>Zohr</th>
                        <th>Asr</th>
                        <th>Isha</th>
                        <th>Fajr</th>
                        <th>Zohr</th>
                        <th>Asr</th>
                        <th>Iftari</th>
                        <th>Isha</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="sunnah-section">
            <h2>Some Sunnah of Ramadan</h2>
            <div class="sunnah-grid">
                <div class="sunnah-item">
                    <strong>Sahoor</strong>
                    It is Sunnah to have a Sahoor meal before beginning the fast.
                </div>
                <div class="sunnah-item">
                    <strong>Iftar - Breaking the Fast</strong>
                    Break the fast immediately after sunset with dates and water.
                </div>
                <div class="sunnah-item">
                    <strong>Taraweeh Prayers</strong>
                    Perform Taraweeh prayers after Isha prayers.
                </div>
                <div class="sunnah-item">
                    <strong>Quran Recitation</strong>
                    Increase the recitation of the Quran during Ramadan.
                </div>
                <div class="sunnah-item">
                    <strong>Charity (Sadaqah)</strong>
                    The Prophet &#65018; was the most generous in Ramadan. Charity given in Ramadan is greatly rewarded.
                </div>
                <div class="sunnah-item">
                    <strong>Laylat Al-Qadr</strong>
                    Seek Laylat Al-Qadr in the last ten nights of Ramadan, especially the odd nights (21, 23, 25, 27, 29).
                </div>
                <div class="sunnah-item">
                    <strong>Dua (Supplication)</strong>
                    The Prophet &#65018; said: "Three people whose dua is not rejected: the fasting person, the just ruler, and the oppressed." (Tirmidhi)
                </div>
                <div class="sunnah-item">
                    <strong>Itikaf</strong>
                    Observe Itikaf during the last ten nights of Ramadan.
                </div>
                <div class="sunnah-item">
                    <strong>Increase in Good Deeds</strong>
                    Ramadan is a time to increase in acts of worship and good deeds.
                </div>
                <div class="sunnah-item">
                    <strong>Seeking Forgiveness</strong>
                    Seek forgiveness and make Tawbah. Ramadan is a time for spiritual renewal.
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-section eid-info">
                <strong>Eid Salah:</strong><br>
                9:00 AM
            </div>
            <div class="footer-section fitrana-box">
                <strong>Sadaqatul Fitr:</strong><br>
                &pound;5.00 per person<br>
                <em style="font-size: 11px;">Must be paid before Eid Salah</em>
            </div>
            <div class="footer-section contact-box">
                <strong>Receiver Frequency:</strong> 456.62500
            </div>
        </div>

        <div style="background: #1a1a1a; color: white; padding: 12px 15px; text-align: center; font-size: 11px;">
            <strong>For Donations (Lillah Only):</strong>
            Al Mahadul Islami | Sort Code: <strong>20-76-92</strong> | Account: <strong>13161595</strong>
        </div>

        <div style="background: #1a1a2e; padding: 10px 15px; text-align: center; font-size: 12px;">
            <a href="https://forms.gle/W6W57QjbAgz8CzYn9" target="_blank" style="color: rgba(255,255,255,0.5); text-decoration: none; margin: 0 10px; transition: color 0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">&#x1F4CB; Submit a Timetable</a>
            <span style="color: rgba(255,255,255,0.15);">|</span>
            <a href="https://forms.gle/W6W57QjbAgz8CzYn9" target="_blank" style="color: rgba(255,255,255,0.5); text-decoration: none; margin: 0 10px; transition: color 0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">&#x26A0;&#xFE0F; Report an Error</a>
        </div>
    </div>

    <button class="notify-btn" id="notifyBtn" onclick="toggleNotifications()" title="Enable Sehri/Iftar reminders">&#x1F514;</button>
    <button class="audio-btn" id="audioBtn" onclick="toggleAudioAlert()" title="Toggle audio alert">&#x1F507;</button>
    <button class="share-btn" onclick="shareWhatsApp()" title="Share on WhatsApp">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    </button>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">&#x1F319;</button>
    <button class="qibla-btn" id="qiblaBtn" onclick="openQibla()" title="Qibla direction">&#x1F9ED;</button>

    <div class="qibla-overlay" id="qiblaOverlay" onclick="closeQibla(event)">
        <div class="qibla-compass-box">
            <button class="qibla-close" onclick="closeQibla(event)">&times;</button>
            <h3>Qibla Direction</h3>
            <p>From Bradford, UK to the Ka'bah</p>
            <div class="qibla-compass-dial" id="qiblaCompassDial">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <!-- Outer ring -->
                    <circle cx="100" cy="100" r="95" fill="none" stroke="#e8f5e9" stroke-width="2"/>
                    <circle cx="100" cy="100" r="85" fill="none" stroke="#c8e6c9" stroke-width="1"/>
                    <!-- Cardinal directions -->
                    <text x="100" y="18" text-anchor="middle" fill="#1b5e20" font-size="14" font-weight="bold">N</text>
                    <text x="100" y="196" text-anchor="middle" fill="#666" font-size="12">S</text>
                    <text x="8" y="104" text-anchor="middle" fill="#666" font-size="12">W</text>
                    <text x="192" y="104" text-anchor="middle" fill="#666" font-size="12">E</text>
                    <!-- Degree ticks -->
                    <line x1="100" y1="8" x2="100" y2="18" stroke="#1b5e20" stroke-width="2"/>
                    <line x1="100" y1="182" x2="100" y2="192" stroke="#ccc" stroke-width="1"/>
                    <line x1="8" y1="100" x2="18" y2="100" stroke="#ccc" stroke-width="1"/>
                    <line x1="182" y1="100" x2="192" y2="100" stroke="#ccc" stroke-width="1"/>
                    <!-- Inner compass rose -->
                    <circle cx="100" cy="100" r="6" fill="#1b5e20"/>
                    <!-- Qibla arrow - pointing ~119.7 degrees from north -->
                    <g id="qiblaArrow" transform="rotate(119.7, 100, 100)">
                        <line x1="100" y1="100" x2="100" y2="25" stroke="#388e3c" stroke-width="3" stroke-linecap="round"/>
                        <polygon points="100,20 94,35 106,35" fill="#388e3c"/>
                        <text x="100" y="48" text-anchor="middle" fill="#388e3c" font-size="10" font-weight="bold">QIBLA</text>
                    </g>
                </svg>
            </div>
            <div class="qibla-bearing">Bearing: 119.7&deg; (ESE)</div>
            <p id="qiblaLiveStatus" style="margin-top:8px;font-size:11px;color:#999;"></p>
        </div>
    </div>

    <script>
        const timetableData = [
            { date: [2026, 2, 18], day: "Wed", no: 1, sehri: "5:39", fajr: "5:44", sunrise: "7:22", zuhr: "12:21", asr: "3:29", isha: "6:29", jFajr: "5:54", jZuhr: "1:00", jAsr: "4:29", maghrib: "5:29", jIsha: "7:15" },
            { date: [2026, 2, 19], day: "Thu", no: 2, sehri: "5:37", fajr: "5:42", sunrise: "7:20", zuhr: "12:21", asr: "3:31", isha: "6:31", jFajr: "5:52", jZuhr: "1:00", jAsr: "4:31", maghrib: "5:31", jIsha: "7:15" },
            { date: [2026, 2, 20], day: "Fri", no: 3, sehri: "5:35", fajr: "5:40", sunrise: "7:17", zuhr: "12:21", asr: "3:32", isha: "6:33", jFajr: "5:50", jZuhr: "1:00", jAsr: "4:33", maghrib: "5:33", jIsha: "7:15" },
            { date: [2026, 2, 21], day: "Sat", no: 4, sehri: "5:33", fajr: "5:38", sunrise: "7:15", zuhr: "12:21", asr: "3:34", isha: "6:35", jFajr: "5:48", jZuhr: "1:00", jAsr: "4:35", maghrib: "5:35", jIsha: "7:15" },
            { date: [2026, 2, 22], day: "Sun", no: 5, sehri: "5:31", fajr: "5:36", sunrise: "7:13", zuhr: "12:20", asr: "3:36", isha: "6:37", jFajr: "5:46", jZuhr: "1:00", jAsr: "4:37", maghrib: "5:37", jIsha: "7:15" },
            { date: [2026, 2, 23], day: "Mon", no: 6, sehri: "5:29", fajr: "5:34", sunrise: "7:11", zuhr: "12:20", asr: "3:38", isha: "6:39", jFajr: "5:44", jZuhr: "1:00", jAsr: "4:39", maghrib: "5:39", jIsha: "7:15" },
            { date: [2026, 2, 24], day: "Tue", no: 7, sehri: "5:27", fajr: "5:32", sunrise: "7:09", zuhr: "12:20", asr: "3:39", isha: "6:41", jFajr: "5:42", jZuhr: "1:00", jAsr: "4:41", maghrib: "5:41", jIsha: "7:15" },
            { date: [2026, 2, 25], day: "Wed", no: 8, sehri: "5:25", fajr: "5:30", sunrise: "7:06", zuhr: "12:20", asr: "3:41", isha: "6:43", jFajr: "5:40", jZuhr: "1:00", jAsr: "4:43", maghrib: "5:43", jIsha: "7:15" },
            { date: [2026, 2, 26], day: "Thu", no: 9, sehri: "5:23", fajr: "5:28", sunrise: "7:04", zuhr: "12:20", asr: "3:43", isha: "6:45", jFajr: "5:38", jZuhr: "1:00", jAsr: "4:45", maghrib: "5:45", jIsha: "7:15" },
            { date: [2026, 2, 27], day: "Fri", no: 10, sehri: "5:20", fajr: "5:25", sunrise: "7:02", zuhr: "12:20", asr: "3:45", isha: "6:47", jFajr: "5:35", jZuhr: "1:00", jAsr: "4:47", maghrib: "5:47", jIsha: "7:15" },
            { date: [2026, 2, 28], day: "Sat", no: 11, sehri: "5:18", fajr: "5:23", sunrise: "7:00", zuhr: "12:20", asr: "3:46", isha: "6:49", jFajr: "5:33", jZuhr: "1:00", jAsr: "4:49", maghrib: "5:49", jIsha: "7:15" },
            { date: [2026, 3, 1], day: "Sun", no: 12, sehri: "5:14", fajr: "5:19", sunrise: "6:55", zuhr: "12:19", asr: "3:50", isha: "6:53", jFajr: "5:29", jZuhr: "1:00", jAsr: "4:53", maghrib: "5:53", jIsha: "7:30" },
            { date: [2026, 3, 2], day: "Mon", no: 13, sehri: "5:11", fajr: "5:16", sunrise: "6:53", zuhr: "12:19", asr: "3:52", isha: "6:55", jFajr: "5:26", jZuhr: "1:00", jAsr: "4:55", maghrib: "5:55", jIsha: "7:30" },
            { date: [2026, 3, 3], day: "Tue", no: 14, sehri: "5:09", fajr: "5:14", sunrise: "6:50", zuhr: "12:19", asr: "3:53", isha: "6:57", jFajr: "5:24", jZuhr: "1:00", jAsr: "4:57", maghrib: "5:57", jIsha: "7:30" },
            { date: [2026, 3, 4], day: "Wed", no: 15, sehri: "5:07", fajr: "5:12", sunrise: "6:48", zuhr: "12:19", asr: "3:55", isha: "6:58", jFajr: "5:22", jZuhr: "1:00", jAsr: "4:58", maghrib: "5:58", jIsha: "7:30" },
            { date: [2026, 3, 5], day: "Thu", no: 16, sehri: "5:04", fajr: "5:09", sunrise: "6:45", zuhr: "12:18", asr: "3:57", isha: "7:00", jFajr: "5:19", jZuhr: "1:00", jAsr: "5:00", maghrib: "6:00", jIsha: "7:30" },
            { date: [2026, 3, 6], day: "Fri", no: 17, sehri: "5:02", fajr: "5:07", sunrise: "6:43", zuhr: "12:18", asr: "3:58", isha: "7:02", jFajr: "5:17", jZuhr: "1:00", jAsr: "5:02", maghrib: "6:02", jIsha: "7:30" },
            { date: [2026, 3, 7], day: "Sat", no: 18, sehri: "4:59", fajr: "5:04", sunrise: "6:41", zuhr: "12:18", asr: "4:00", isha: "7:04", jFajr: "5:14", jZuhr: "1:00", jAsr: "5:04", maghrib: "6:04", jIsha: "7:45" },
            { date: [2026, 3, 8], day: "Sun", no: 19, sehri: "4:57", fajr: "5:02", sunrise: "6:38", zuhr: "12:18", asr: "4:01", isha: "7:06", jFajr: "5:12", jZuhr: "1:00", jAsr: "5:06", maghrib: "6:06", jIsha: "7:45" },
            { date: [2026, 3, 9], day: "Mon", no: 20, sehri: "4:54", fajr: "4:59", sunrise: "6:36", zuhr: "12:17", asr: "4:03", isha: "7:08", jFajr: "5:09", jZuhr: "1:00", jAsr: "5:08", maghrib: "6:08", jIsha: "7:45" },
            { date: [2026, 3, 10], day: "Tue", no: 21, sehri: "4:52", fajr: "4:57", sunrise: "6:34", zuhr: "12:17", asr: "4:05", isha: "7:10", jFajr: "5:07", jZuhr: "1:00", jAsr: "5:10", maghrib: "6:10", jIsha: "7:45" },
            { date: [2026, 3, 11], day: "Wed", no: 22, sehri: "4:50", fajr: "4:55", sunrise: "6:31", zuhr: "12:17", asr: "4:06", isha: "7:12", jFajr: "5:05", jZuhr: "1:00", jAsr: "5:12", maghrib: "6:12", jIsha: "7:45" },
            { date: [2026, 3, 12], day: "Thu", no: 23, sehri: "4:47", fajr: "4:52", sunrise: "6:29", zuhr: "12:17", asr: "4:08", isha: "7:14", jFajr: "5:02", jZuhr: "1:00", jAsr: "5:14", maghrib: "6:14", jIsha: "7:45" },
            { date: [2026, 3, 13], day: "Fri", no: 24, sehri: "4:44", fajr: "4:49", sunrise: "6:26", zuhr: "12:16", asr: "4:09", isha: "7:16", jFajr: "4:59", jZuhr: "1:00", jAsr: "5:16", maghrib: "6:16", jIsha: "7:45" },
            { date: [2026, 3, 14], day: "Sat", no: 25, sehri: "4:42", fajr: "4:47", sunrise: "6:24", zuhr: "12:16", asr: "4:11", isha: "7:18", jFajr: "4:57", jZuhr: "1:00", jAsr: "5:18", maghrib: "6:18", jIsha: "8:00" },
            { date: [2026, 3, 15], day: "Sun", no: 26, sehri: "4:39", fajr: "4:44", sunrise: "6:21", zuhr: "12:16", asr: "4:12", isha: "7:19", jFajr: "4:54", jZuhr: "1:00", jAsr: "5:19", maghrib: "6:19", jIsha: "8:00" },
            { date: [2026, 3, 16], day: "Mon", no: 27, sehri: "4:37", fajr: "4:42", sunrise: "6:19", zuhr: "12:16", asr: "4:14", isha: "7:21", jFajr: "4:52", jZuhr: "1:00", jAsr: "5:21", maghrib: "6:21", jIsha: "8:00" },
            { date: [2026, 3, 17], day: "Tue", no: 28, sehri: "4:34", fajr: "4:39", sunrise: "6:17", zuhr: "12:15", asr: "4:16", isha: "7:23", jFajr: "4:49", jZuhr: "1:00", jAsr: "5:23", maghrib: "6:23", jIsha: "8:00" },
            { date: [2026, 3, 18], day: "Wed", no: 29, sehri: "4:31", fajr: "4:36", sunrise: "6:14", zuhr: "12:15", asr: "4:17", isha: "7:25", jFajr: "4:46", jZuhr: "1:00", jAsr: "5:25", maghrib: "6:25", jIsha: "8:00" },
            { date: [2026, 3, 19], day: "Thu", no: 30, sehri: "4:29", fajr: "4:34", sunrise: "6:12", zuhr: "12:15", asr: "4:19", isha: "7:27", jFajr: "4:44", jZuhr: "1:00", jAsr: "5:27", maghrib: "6:27", jIsha: "8:00" },
        ];

        const ramadanStart = new Date(2026, 1, 18);
        const ramadanEnd = new Date(2026, 2, 19);
        var eidConfettiLaunched = false;

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            tbody.innerHTML = timetableData.map((row) => {
                const rowDate = new Date(row.date[0], row.date[1] - 1, row.date[2]);
                const isToday = rowDate.getTime() === today.getTime();
                const isFriday = row.day === "Fri";
                const isLastTen = row.no >= 21;
                const isOddNight = row.no >= 21 && row.no % 2 === 1;

                let rowClasses = [];
                if (isToday) rowClasses.push('today');
                else if (isFriday) rowClasses.push('friday');
                if (isOddNight) rowClasses.push('odd-night');
                else if (isLastTen) rowClasses.push('last-ten');

                const todayBadge = isToday ? '<span class="today-badge">TODAY</span>' : '';
                const lastTenBadge = isOddNight ? '<span class="last-ten-badge">ODD</span>' : '';

                return `
                    <tr class="${rowClasses.join(' ')}">
                        <td class="date-col">${row.date[2]}${todayBadge}</td>
                        <td class="day-col">${row.day}</td>
                        <td class="no-col">${row.no}${lastTenBadge}</td>
                        <td class="sehri-col">${row.sehri}</td>
                        <td>${row.fajr}</td>
                        <td>${row.sunrise}</td>
                        <td>${row.zuhr}</td>
                        <td>${row.asr}</td>
                        <td>${row.isha}</td>
                        <td>${row.jFajr}</td>
                        <td>${row.jZuhr}</td>
                        <td>${row.jAsr}</td>
                        <td class="iftari-col">${row.maghrib}</td>
                        <td>${row.jIsha}</td>
                    </tr>
                `;
            }).join('');

            const todayRow = document.querySelector('.today');
            if (todayRow) {
                setTimeout(() => todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
            }
        }

        function getTodayData() {
            const today = new Date();
            return timetableData.find(row => {
                const rowDate = new Date(row.date[0], row.date[1] - 1, row.date[2]);
                return rowDate.toDateString() === today.toDateString();
            });
        }

        function updateCountdown() {
            const now = new Date();
            const todayData = getTodayData();
            const countdownSection = document.getElementById('countdownSection');
            const daysContainer = document.getElementById('daysContainer');

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (today < ramadanStart) {
                countdownSection.className = 'countdown-section pre-ramadan';
                daysContainer.style.display = 'block';
                const diff = ramadanStart - now;
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('countdownLabel').textContent = 'Countdown to Ramadan 1447';
                document.getElementById('days').textContent = d.toString().padStart(2, '0');
                document.getElementById('hours').textContent = h.toString().padStart(2, '0');
                document.getElementById('minutes').textContent = m.toString().padStart(2, '0');
                document.getElementById('seconds').textContent = s.toString().padStart(2, '0');
                document.getElementById('nextPrayer').innerHTML = 'Ramadan begins <span class="next-prayer-time">Wed 18th February</span>';
                return;
            }

            if (today > ramadanEnd) {
                countdownSection.className = 'countdown-section';
                daysContainer.style.display = 'none';
                document.getElementById('countdownLabel').textContent = 'Ramadan 1447 has ended';
                document.getElementById('hours').textContent = '--';
                document.getElementById('minutes').textContent = '--';
                document.getElementById('seconds').textContent = '--';
                document.getElementById('nextPrayer').innerHTML = '<span class="next-prayer-time">Eid Mubarak!</span>';
                // Feature 3: Launch Eid confetti
                if (!eidConfettiLaunched) { eidConfettiLaunched = true; launchEidConfetti(); }
                return;
            }

            daysContainer.style.display = 'none';

            if (!todayData) {
                countdownSection.className = 'countdown-section';
                document.getElementById('countdownLabel').textContent = 'Ramadan timetable for Feb 18 - Mar 19, 2026';
                document.getElementById('hours').textContent = '--';
                document.getElementById('minutes').textContent = '--';
                document.getElementById('seconds').textContent = '--';
                document.getElementById('nextPrayer').textContent = '';
                return;
            }

            function toDate(timeStr, isPM) {
                const [h, m] = timeStr.split(':').map(Number);
                const d = new Date(now);
                d.setHours(isPM && h < 12 ? h + 12 : h, m, 0, 0);
                return d;
            }

            const events = [
                { label: 'Sehri ends', time: toDate(todayData.sehri, false), display: todayData.sehri, isIftar: false },
                { label: 'Fajr Jamaah', time: toDate(todayData.jFajr, false), display: todayData.jFajr, isIftar: false },
                { label: 'Zohr begins', time: toDate(todayData.zuhr, false), display: todayData.zuhr, isIftar: false },
                { label: 'Zohr Jamaah', time: toDate(todayData.jZuhr, true), display: todayData.jZuhr, isIftar: false },
                { label: 'Asr begins', time: toDate(todayData.asr, true), display: todayData.asr, isIftar: false },
                { label: 'Asr Jamaah', time: toDate(todayData.jAsr, true), display: todayData.jAsr, isIftar: false },
                { label: 'Iftar', time: toDate(todayData.maghrib, true), display: todayData.maghrib, isIftar: true },
                { label: 'Isha begins', time: toDate(todayData.isha, true), display: todayData.isha, isIftar: false },
                { label: 'Isha Jamaah', time: toDate(todayData.jIsha, true), display: todayData.jIsha, isIftar: false },
            ];

            const nextEvent = events.find(e => now < e.time);

            if (nextEvent) {
                const diff = nextEvent.time - now;
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                countdownSection.className = 'countdown-section' + (nextEvent.isIftar ? ' iftar-mode' : '');
                document.getElementById('countdownLabel').textContent = nextEvent.label;
                document.getElementById('hours').textContent = h.toString().padStart(2, '0');
                document.getElementById('minutes').textContent = m.toString().padStart(2, '0');
                document.getElementById('seconds').textContent = s.toString().padStart(2, '0');
                document.getElementById('nextPrayer').innerHTML = `${nextEvent.label} at <span class="next-prayer-time">${nextEvent.display}</span>`;
                return;
            }

            const tomorrowIndex = timetableData.indexOf(todayData) + 1;
            if (tomorrowIndex < timetableData.length) {
                const tmrw = timetableData[tomorrowIndex];
                const [sH, sM] = tmrw.sehri.split(':').map(Number);
                const sehriTmrw = new Date(now);
                sehriTmrw.setDate(sehriTmrw.getDate() + 1);
                sehriTmrw.setHours(sH, sM, 0, 0);
                const diff = sehriTmrw - now;
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                countdownSection.className = 'countdown-section';
                document.getElementById('countdownLabel').textContent = 'Sehri ends tomorrow';
                document.getElementById('hours').textContent = h.toString().padStart(2, '0');
                document.getElementById('minutes').textContent = m.toString().padStart(2, '0');
                document.getElementById('seconds').textContent = s.toString().padStart(2, '0');
                document.getElementById('nextPrayer').innerHTML = `Sehri ends at <span class="next-prayer-time">${tmrw.sehri}</span>`;
                return;
            }

            countdownSection.className = 'countdown-section';
            document.getElementById('countdownLabel').textContent = 'Eid Mubarak!';
            document.getElementById('hours').textContent = '00';
            document.getElementById('minutes').textContent = '00';
            document.getElementById('seconds').textContent = '00';
            document.getElementById('nextPrayer').innerHTML = '<span class="next-prayer-time">Ramadan 1447 complete</span>';
            // Feature 3: Launch Eid confetti
            if (!eidConfettiLaunched) { eidConfettiLaunched = true; launchEidConfetti(); }
        }

        let notificationsEnabled = localStorage.getItem('almahad-notifications') === 'true';
        let lastNotification = '';

        function toggleNotifications() {
            if (!('Notification' in window)) { alert('Your browser does not support notifications.'); return; }
            if (notificationsEnabled) {
                notificationsEnabled = false;
                localStorage.setItem('almahad-notifications', 'false');
                updateNotifyButton();
                return;
            }
            Notification.requestPermission().then(perm => {
                if (perm === 'granted') {
                    notificationsEnabled = true;
                    localStorage.setItem('almahad-notifications', 'true');
                    new Notification('Reminders enabled', { body: 'You will be notified 15 minutes before Sehri ends and Iftar.' });
                }
                updateNotifyButton();
            });
        }

        function updateNotifyButton() {
            const btn = document.getElementById('notifyBtn');
            if (notificationsEnabled) { btn.classList.add('active'); btn.title = 'Disable Sehri/Iftar reminders'; }
            else { btn.classList.remove('active'); btn.title = 'Enable Sehri/Iftar reminders'; }
        }

        function checkNotifications() {
            if (!notificationsEnabled) return;
            const todayData = getTodayData();
            if (!todayData) return;
            const now = new Date();
            const currentMins = now.getHours() * 60 + now.getMinutes();
            const [sehriH, sehriM] = todayData.sehri.split(':').map(Number);
            const sehriMins = sehriH * 60 + sehriM;
            const [iftarH, iftarM] = todayData.maghrib.split(':').map(Number);
            const iftarMins = (iftarH < 12 ? iftarH + 12 : iftarH) * 60 + iftarM;
            const key = now.toDateString();
            if (currentMins === sehriMins - 15 && lastNotification !== key + '-sehri') {
                lastNotification = key + '-sehri';
                new Notification('Sehri ending soon!', { body: `Sehri ends at ${todayData.sehri} - 15 minutes remaining.` });
            }
            if (currentMins === iftarMins - 15 && lastNotification !== key + '-iftar') {
                lastNotification = key + '-iftar';
                new Notification('Iftar in 15 minutes!', { body: `Iftar at ${todayData.maghrib} - almost time to break your fast.` });
            }
        }

        function shareWhatsApp() {
            const text = encodeURIComponent('Ramadan 1447 Prayer Timetable - Al Mahad Ul Islami, Bradford\nhttps://waqt.uk/Almahad/');
            window.open('https://wa.me/?text=' + text, '_blank');
        }

        function toggleDarkMode(isAutoToggle) {
            document.body.classList.toggle('dark-mode');
            const btn = document.querySelector('.dark-mode-toggle');
            btn.textContent = document.body.classList.contains('dark-mode') ? '\u2600\uFE0F' : '\uD83C\uDF19';
            localStorage.setItem('almahad-darkMode', document.body.classList.contains('dark-mode'));
            // If manual toggle, disable auto dark mode
            if (!isAutoToggle) {
                localStorage.setItem('almahad-autoDark', 'false');
            }
        }

        // Today View
        let currentView = localStorage.getItem('almahad-viewMode') || 'today';

        function renderTodayView() {
            const todayData = getTodayData();
            if (!todayData) {
                document.getElementById('todayCards').innerHTML = '<div style="text-align:center;padding:30px;opacity:0.6;">No timetable data for today</div>';
                document.getElementById('todayDateBar').textContent = '';
                document.getElementById('todayTomorrow').style.display = 'none';
                return;
            }
            const now = new Date();
            const rowDate = new Date(todayData.date[0], todayData.date[1] - 1, todayData.date[2]);
            const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            document.getElementById('todayDateBar').textContent =
                `Day ${todayData.no || 'Eid'} of Ramadan  \u2022  ${dayNames[rowDate.getDay()]} ${rowDate.getDate()} ${monthNames[rowDate.getMonth()]} ${rowDate.getFullYear()}`;

            function toDate24(timeStr, isPM) {
                const [h, m] = timeStr.split(':').map(Number);
                const d = new Date(now); d.setHours(isPM && h < 12 ? h + 12 : h, m, 0, 0); return d;
            }
            const isFriday = todayData.day === 'Fri';
            const prayers = [
                { name: 'Sehri', mainTime: todayData.sehri, isPM: false, details: [{label:'Fajr Start',value:todayData.fajr},{label:'Fajr Jamaah',value:todayData.jFajr}], eventTime: toDate24(todayData.sehri, false) },
                { name: 'Sunrise', mainTime: todayData.sunrise, isPM: false, details: [], eventTime: toDate24(todayData.sunrise, false) },
                { name: isFriday ? 'Jumu\'ah' : 'Zohr', mainTime: todayData.zuhr, isPM: false, details: [{label:'Jamaah',value:todayData.jZuhr}], eventTime: toDate24(todayData.zuhr, false) },
                { name: 'Asr', mainTime: todayData.asr, isPM: true, details: [{label:'Jamaah',value:todayData.jAsr}], eventTime: toDate24(todayData.asr, true) },
                { name: 'Iftari / Maghrib', mainTime: todayData.maghrib, isPM: true, details: [], eventTime: toDate24(todayData.maghrib, true) },
                { name: 'Isha', mainTime: todayData.isha, isPM: true, details: [{label:'Jamaah',value:todayData.jIsha}], eventTime: toDate24(todayData.isha, true) }
            ];
            let nextIndex = -1;
            for (let i = 0; i < prayers.length; i++) { if (now < prayers[i].eventTime) { nextIndex = i; break; } }
            document.getElementById('todayCards').innerHTML = prayers.map((p, i) => {
                const isPassed = nextIndex === -1 || i < nextIndex;
                const isNext = i === nextIndex;
                let cls = 'prayer-card';
                if (isPassed && nextIndex !== -1) cls += ' passed';
                if (isNext) cls += ' active-prayer';
                const badge = isNext ? '<span class="next-badge">NEXT</span>' : '';
                const details = p.details.length ? `<div class="prayer-card-details">${p.details.map(d=>`<div class="prayer-card-detail">${d.label} <strong>${d.value}</strong></div>`).join('')}</div>` : '';
                return `<div class="${cls}"><div class="prayer-card-header"><div class="prayer-card-name">${p.name}${badge}</div><div class="prayer-card-time">${p.mainTime}</div></div>${details}</div>`;
            }).join('');
            const tomorrowIndex = timetableData.indexOf(todayData) + 1;
            const tmrwEl = document.getElementById('todayTomorrow');
            if (tomorrowIndex < timetableData.length) {
                const tmrw = timetableData[tomorrowIndex];
                tmrwEl.innerHTML = `Tomorrow: Sehri ends <strong>${tmrw.sehri}</strong> &nbsp;\u2022&nbsp; Iftari <strong>${tmrw.maghrib}</strong>`;
                tmrwEl.style.display = '';
            } else { tmrwEl.style.display = 'none'; }
        }

        function setView(view) {
            currentView = view;
            localStorage.setItem('almahad-viewMode', view);
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
            if (view === 'today') {
                document.getElementById('todayView').style.display = '';
                document.getElementById('tableContainer').style.display = 'none';
                renderTodayView();
            } else {
                document.getElementById('todayView').style.display = 'none';
                document.getElementById('tableContainer').style.display = '';
            }
        }

        // === FEATURE 6: Audio Alert (Web Audio API) ===
        let audioAlertEnabled = localStorage.getItem('almahad-audioAlert') === 'true';

        function playChime() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const notes = [659.25, 830.61, 987.77]; // E5, G#5, B5
                notes.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.22);
                    gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.22);
                    gain.gain.linearRampToValueAtTime(0.25, ctx.currentTime + i * 0.22 + 0.03);
                    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + i * 0.22 + 0.2);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(ctx.currentTime + i * 0.22);
                    osc.stop(ctx.currentTime + i * 0.22 + 0.25);
                });
                setTimeout(() => ctx.close(), 1500);
            } catch(e) {}
        }

        function toggleAudioAlert() {
            audioAlertEnabled = !audioAlertEnabled;
            localStorage.setItem('almahad-audioAlert', audioAlertEnabled);
            updateAudioButton();
            if (audioAlertEnabled) playChime(); // Preview sound
        }

        function updateAudioButton() {
            const btn = document.getElementById('audioBtn');
            if (audioAlertEnabled) {
                btn.classList.add('active');
                btn.innerHTML = '&#x1F50A;';
                btn.title = 'Disable audio alert';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '&#x1F507;';
                btn.title = 'Enable audio alert';
            }
        }

        // === FEATURE 7: Qibla Compass ===
        let qiblaOrientationHandler = null;

        function openQibla() {
            document.getElementById('qiblaOverlay').classList.add('visible');
            // Try live compass on mobile
            if (window.DeviceOrientationEvent) {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // iOS 13+
                    DeviceOrientationEvent.requestPermission().then(function(resp) {
                        if (resp === 'granted') startCompass();
                        else document.getElementById('qiblaLiveStatus').textContent = 'Compass permission denied. Showing static bearing.';
                    }).catch(function() {
                        document.getElementById('qiblaLiveStatus').textContent = 'Showing static bearing.';
                    });
                } else {
                    startCompass();
                }
            } else {
                document.getElementById('qiblaLiveStatus').textContent = 'Compass not available. Showing static bearing.';
            }
        }

        function startCompass() {
            var gotReading = false;
            qiblaOrientationHandler = function(e) {
                var alpha = e.alpha; // Device heading
                if (alpha === null || alpha === undefined) return;
                gotReading = true;
                var qiblaBearing = 119.7;
                // Rotate the whole compass so N is at device north, arrow stays at qibla
                var dialRotation = -alpha;
                var arrowEl = document.getElementById('qiblaArrow');
                if (arrowEl) {
                    // Reset arrow to qibla bearing, rotate dial for device heading
                    var dial = document.querySelector('#qiblaCompassDial svg');
                    if (dial) dial.style.transform = 'rotate(' + dialRotation + 'deg)';
                }
                document.getElementById('qiblaLiveStatus').textContent = 'Live compass active. Point your device to follow the arrow.';
            };
            window.addEventListener('deviceorientation', qiblaOrientationHandler);
            setTimeout(function() {
                if (!gotReading) {
                    document.getElementById('qiblaLiveStatus').textContent = 'No compass data. Showing static bearing.';
                }
            }, 2000);
        }

        function closeQibla(e) {
            if (e.target === document.getElementById('qiblaOverlay') || e.target.classList.contains('qibla-close')) {
                document.getElementById('qiblaOverlay').classList.remove('visible');
                if (qiblaOrientationHandler) {
                    window.removeEventListener('deviceorientation', qiblaOrientationHandler);
                    qiblaOrientationHandler = null;
                }
                // Reset dial rotation
                var dial = document.querySelector('#qiblaCompassDial svg');
                if (dial) dial.style.transform = '';
                document.getElementById('qiblaLiveStatus').textContent = '';
            }
        }

        // === FEATURE 3: Eid Confetti Burst ===
        function launchEidConfetti() {
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            if (document.getElementById('eidConfettiCanvas')) return; // Already running
            var canvas = document.createElement('canvas');
            canvas.id = 'eidConfettiCanvas';
            document.body.appendChild(canvas);
            var ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            var colors = ['#388e3c', '#ffd54f', '#ffffff', '#2e7d32'];
            var particles = [];
            for (var i = 0; i < 150; i++) {
                particles.push({
                    x: canvas.width / 2 + (Math.random() - 0.5) * 100,
                    y: 0,
                    vx: (Math.random() - 0.5) * 12,
                    vy: Math.random() * -8 - 2,
                    w: Math.random() * 8 + 4,
                    h: Math.random() * 6 + 3,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    rot: Math.random() * 360,
                    rotV: (Math.random() - 0.5) * 10,
                    alpha: 1
                });
            }
            var startTime = performance.now();
            function drawConfetti(t) {
                var elapsed = t - startTime;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                var alive = false;
                for (var i = 0; i < particles.length; i++) {
                    var p = particles[i];
                    p.vy += 0.18; // gravity
                    p.x += p.vx;
                    p.y += p.vy;
                    p.rot += p.rotV;
                    p.vx *= 0.99;
                    if (elapsed > 3500) p.alpha = Math.max(0, p.alpha - 0.02);
                    if (p.alpha <= 0) continue;
                    alive = true;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rot * Math.PI / 180);
                    ctx.globalAlpha = p.alpha;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                    ctx.restore();
                }
                if (alive && elapsed < 5000) {
                    requestAnimationFrame(drawConfetti);
                } else {
                    canvas.remove();
                }
            }
            requestAnimationFrame(drawConfetti);
        }

        // === FEATURE 4: Ramadan Progress Bar ===
        function updateRamadanProgress() {
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var bar = document.getElementById('ramadanProgress');
            if (!bar) return;
            if (today < ramadanStart || today > ramadanEnd) {
                bar.style.display = 'none';
                return;
            }
            var todayData = getTodayData();
            if (!todayData) { bar.style.display = 'none'; return; }
            bar.style.display = '';
            var dayNum = todayData.no;
            var totalDays = timetableData.length;
            var pct = (dayNum / totalDays) * 100;
            document.getElementById('ramadanProgressFill').style.width = pct + '%';
            document.getElementById('ramadanProgressText').textContent = 'Day ' + dayNum + ' of ' + totalDays;
        }

        // === FEATURE 5: Auto Dark Mode at Maghrib ===
        function checkAutoDark() {
            var autoDark = localStorage.getItem('almahad-autoDark');
            if (autoDark === 'false') return; // User manually toggled, respect their choice
            var todayData = getTodayData();
            if (!todayData) return;
            var now = new Date();
            var currentMins = now.getHours() * 60 + now.getMinutes();
            // Parse Fajr (AM)
            var fajrParts = todayData.fajr.split(':').map(Number);
            var fajrMins = fajrParts[0] * 60 + fajrParts[1];
            // Parse Maghrib (PM)
            var maghParts = todayData.maghrib.split(':').map(Number);
            var maghH = maghParts[0] < 12 ? maghParts[0] + 12 : maghParts[0];
            var maghMins = maghH * 60 + maghParts[1];
            var isDark = document.body.classList.contains('dark-mode');
            // After Maghrib: enable dark mode
            if (currentMins >= maghMins && !isDark) {
                toggleDarkMode(true);
            }
            // After Fajr but before Maghrib: disable dark mode
            if (currentMins >= fajrMins && currentMins < maghMins && isDark) {
                toggleDarkMode(true);
            }
        }

        // Wrap original notification check to also trigger audio
        var origCheckNotifications = checkNotifications;
        checkNotifications = function() {
            var prevLast = lastNotification;
            origCheckNotifications();
            // If a notification was just sent and audio is enabled, play chime
            if (lastNotification !== prevLast && audioAlertEnabled) {
                playChime();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Feature 9: Add shimmer to header while Granim loads
            document.querySelector('.header').classList.add('granim-loading');

            if (localStorage.getItem('almahad-darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-toggle').textContent = '\u2600\uFE0F';
            }
            renderTable();
            updateCountdown();
            setInterval(updateCountdown, 1000);
            setInterval(checkNotifications, 30000);
            updateNotifyButton();
            updateAudioButton();

            document.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', () => setView(btn.dataset.view)));
            const todayData = getTodayData();
            if (!localStorage.getItem('almahad-viewMode')) { currentView = todayData ? 'today' : 'full'; }
            setView(currentView);
            setInterval(() => { if (currentView === 'today') renderTodayView(); }, 60000);

            // Feature 4: Ramadan progress bar
            updateRamadanProgress();

            // Feature 5: Auto dark mode check on load + every 60s
            checkAutoDark();
            setInterval(checkAutoDark, 60000);

            // Feature 3: Check for Eid state and launch confetti
            var label = document.getElementById('countdownLabel');
            if (label && label.textContent.indexOf('Eid Mubarak') !== -1) {
                launchEidConfetti();
                eidConfettiLaunched = true;
            }

            // Register service worker for offline support
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js');
            }
        });
    </script>
    <script src="../nav.js"></script>

    <!-- Granim.js - async loaded -->
    <script>
    (function() {
        var canvas = document.getElementById('granimCanvas');
        if (!canvas) return;
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches || window.innerWidth < 600) {
            canvas.style.display = 'none'; document.querySelector('.header').classList.remove('granim-loading'); return;
        }
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/granim@2.0.0/dist/granim.min.js';
        s.async = true;
        s.onload = function() {
            if (typeof Granim === 'undefined') { canvas.style.display = 'none'; document.querySelector('.header').classList.remove('granim-loading'); return; }
            var isDark = document.body.classList.contains('dark-mode');
            var granimInstance = new Granim({
                element: '#granimCanvas',
                direction: 'diagonal',
                isPausedWhenNotInView: true,
                stateTransitionSpeed: 500,
                states: {
                    "default-state": {
                        gradients: isDark
                            ? [['#0d1a0e', '#1a2e1b'], ['#162e17', '#0d1a0e'], ['#1a2e1b', '#0d1a0e']]
                            : [['#1b5e20', '#388e3c'], ['#2e7d32', '#4caf50'], ['#1b5e20', '#43a047']],
                        transitionSpeed: 4000,
                    }
                }
            });
            // Feature 9: Remove shimmer once Granim is initialized
            document.querySelector('.header').classList.remove('granim-loading');
            var origToggle = window.toggleDarkMode;
            window.toggleDarkMode = function(isAutoToggle) {
                origToggle(isAutoToggle);
                var nowDark = document.body.classList.contains('dark-mode');
                granimInstance.changeState('default-state');
                granimInstance.states['default-state'].gradients = nowDark
                    ? [['#0d1a0e', '#1a2e1b'], ['#162e17', '#0d1a0e'], ['#1a2e1b', '#0d1a0e']]
                    : [['#1b5e20', '#388e3c'], ['#2e7d32', '#4caf50'], ['#1b5e20', '#43a047']];
            };
        };
        s.onerror = function() { canvas.style.display = 'none'; document.querySelector('.header').classList.remove('granim-loading'); };
        document.body.appendChild(s);
    })();
    </script>

    <!-- Floating firefly particles in countdown -->
    <script>
    (function() {
        var canvas = document.getElementById('fireflyCanvas');
        if (!canvas) return;
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) { canvas.style.display = 'none'; return; }
        var ctx = canvas.getContext('2d');
        if (!ctx) { canvas.style.display = 'none'; return; }
        var flies = [], w, h;
        function resize() {
            var rect = canvas.parentElement.getBoundingClientRect();
            w = canvas.width = rect.width;
            h = canvas.height = rect.height;
            flies = [];
            var count = Math.min(Math.floor(w * h / 2000), 50);
            for (var i = 0; i < count; i++) {
                flies.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    r: Math.random() * 1.5 + 0.5,
                    vx: (Math.random() - 0.5) * 0.4,
                    vy: (Math.random() - 0.5) * 0.4,
                    phase: Math.random() * Math.PI * 2,
                    speed: Math.random() * 0.002 + 0.001
                });
            }
        }
        resize();
        window.addEventListener('resize', resize);
        function draw(t) {
            ctx.clearRect(0, 0, w, h);
            for (var i = 0; i < flies.length; i++) {
                var f = flies[i];
                f.x += f.vx + Math.sin(t * 0.001 + f.phase) * 0.15;
                f.y += f.vy + Math.cos(t * 0.001 + f.phase) * 0.15;
                if (f.x < 0) f.x = w;
                if (f.x > w) f.x = 0;
                if (f.y < 0) f.y = h;
                if (f.y > h) f.y = 0;
                var alpha = 0.15 + 0.85 * ((Math.sin(t * f.speed + f.phase) + 1) / 2);
                var grad = ctx.createRadialGradient(f.x, f.y, 0, f.x, f.y, f.r * 3);
                grad.addColorStop(0, 'rgba(255, 213, 79, ' + alpha + ')');
                grad.addColorStop(0.5, 'rgba(255, 179, 0, ' + (alpha * 0.4) + ')');
                grad.addColorStop(1, 'rgba(255, 179, 0, 0)');
                ctx.beginPath();
                ctx.arc(f.x, f.y, f.r * 3, 0, Math.PI * 2);
                ctx.fillStyle = grad;
                ctx.fill();
            }
            requestAnimationFrame(draw);
        }
        requestAnimationFrame(draw);
    })();
    </script>

    <!-- Countdown tick + flip animation -->
    <script>
    (function() {
        var ids = ['hours', 'minutes', 'seconds', 'days'];
        var prev = {};
        ids.forEach(function(id) { prev[id] = ''; });

        setInterval(function() {
            ids.forEach(function(id) {
                var el = document.getElementById(id);
                if (!el) return;
                var val = el.textContent;
                if (val !== prev[id] && prev[id] !== '') {
                    el.classList.add('tick');
                    setTimeout(function() { el.classList.remove('tick'); }, 200);

                    // Feature 1: Flip individual changed digits
                    if (val !== '--' && val.length === prev[id].length) {
                        // Wrap in flip-digit spans with flipping on changed digits
                        var html = '';
                        for (var i = 0; i < val.length; i++) {
                            var changed = val[i] !== prev[id][i];
                            html += '<span class="flip-digit' + (changed ? ' flipping' : '') + '">' + val[i] + '</span>';
                        }
                        el.innerHTML = html;
                        // Remove flipping class after animation
                        var flipping = el.querySelectorAll('.flipping');
                        for (var j = 0; j < flipping.length; j++) {
                            (function(span) {
                                setTimeout(function() { span.classList.remove('flipping'); }, 350);
                            })(flipping[j]);
                        }
                    }
                }
                prev[id] = val;
            });
        }, 250);
    })();
    </script>
</body>
</html>
